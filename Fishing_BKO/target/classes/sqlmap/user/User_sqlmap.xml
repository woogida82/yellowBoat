<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="user">

	<sql id = 'userWhere'>
        AND DEL_YN = 'N'
        
        <if test='searchWordType != null and searchWordType != "" and ((searchWord != null and searchWord != "") or (searchWordS != null and searchWordS != "" and searchWordE != null and searchWordE != ""))'>
            <!-- 부서 -->
            <if test='searchWordType == "dept"'>
                AND DEPT LIKE CONCAT('%',#{searchWord},'%')
            </if>
            <!-- 팀 -->
            <if test='searchWordType == "team"'>
                AND TEAM LIKE CONCAT('%',#{searchWord},'%')
            </if>
            <!-- 아이디 -->
            <if test='searchWordType == "adminId"'>
                AND ADMIN_ID LIKE CONCAT('%',#{searchWord},'%')
            </if>
            <!-- 이름 -->
            <if test='searchWordType == "adminNm"'>
                AND ADMIN_NM LIKE CONCAT('%',#{searchWord},'%')
            </if>
            <!-- 등록자 -->
            <if test='searchWordType == "createId"'>
                AND EXISTS (
                    SELECT 1 FROM T_ADMIN A
                    WHERE A.ADMIN_ID = T_ADMIN.CREATE_ID
                      AND A.ADMIN_NM LIKE CONCAT('%',#{searchWord},'%')
                )
            </if>
            <!-- 수정자 -->
            <if test='searchWordType == "updateId"'>
                AND EXISTS (
                    SELECT 1 FROM T_ADMIN A
                    WHERE A.ADMIN_ID = T_ADMIN.UPDATE_ID
                      AND A.ADMIN_NM LIKE CONCAT('%',#{searchWord},'%')
                )
            </if>
        </if>
                
    </sql>

	<select id="selectUserListCnt" resultType="int">
        SELECT COUNT(1) 
        FROM T_ADMIN
        WHERE 1=1
        <include refid="userWhere"/>
    </select>
    
    
    <select id="selectUserList" resultType="AdminBean">
        SELECT 
        	ADMIN_ID, 
        	ADMIN_NM, 
            (SELECT GROUP_CONCAT(COMMON_NM) FROM T_COMMON_CODE WHERE MASTER_CD='MENU_AUTH' AND FIND_IN_SET(COMMON_CD, MENU_AUTH) > 0 ORDER BY DISP_NO) MENU_AUTH,
        	DEPT, 
        	TEAM, 
        	POST, 
        	DUTY, 
        	ADMIN_NM, 
        	DEL_YN
            ,(SELECT A.ADMIN_NM FROM T_ADMIN A WHERE A.ADMIN_ID = T_ADMIN.UPDATE_ID) UPDATE_ID
            ,DATE_FORMAT( UPDATE_TIME,'%Y.%m.%d %H:%i:%s' ) UPDATE_TIME
            ,(SELECT A.ADMIN_NM FROM T_ADMIN A WHERE A.ADMIN_ID = T_ADMIN.CREATE_ID) CREATE_ID
            ,DATE_FORMAT( CREATE_TIME,'%Y.%m.%d %H:%i:%s' ) CREATE_TIME
          FROM T_ADMIN
         WHERE
           1=1
        <include refid="userWhere"/>
        <if test='sortColumn == null or sortColumn == ""'>
            ORDER BY CREATE_TIME DESC
        </if>
        <include refid="common.paging" />
    </select>
    
    <select id="selectUser" resultType="AdminBean">
        SELECT
            ADMIN_ID, 
        	ADMIN_NM, 
        	MENU_AUTH, 
        	DEPT, 
        	TEAM, 
        	POST, 
        	DUTY, 
        	ADMIN_NM, 
        	DEL_YN
        FROM T_ADMIN
        WHERE ADMIN_ID = #{adminId}
    </select>
    
    <select id="selectUserAdminId" resultType="int">
        SELECT COUNT(1) 
        FROM T_ADMIN
        WHERE ADMIN_ID = #{adminId}
<!--          AND DEL_YN = 'N' -->
    </select>
    
    <insert id="insertUser" parameterType="AdminBean">
        INSERT INTO T_ADMIN (
        	DEL_YN
        	<if test='adminId != null and adminId != ""'>
            ,ADMIN_ID
            </if>
            <if test='adminPw != null and adminPw != ""'>
            ,ADMIN_PW
            </if>
            <if test='menuAuth != null and menuAuth != ""'>
            ,MENU_AUTH
            </if>
            <if test='dept != null and dept != ""'>
            ,DEPT
            </if>
            <if test='team != null and team != ""'>
            ,TEAM
            </if>
            <if test='post != null and post != ""'>
            ,POST
            </if>
            <if test='duty != null and duty != ""'>
            ,DUTY
            </if>
            <if test='adminNm != null and adminNm != ""'>
            ,ADMIN_NM
            </if>
            ,UPDATE_ID
            ,UPDATE_TIME
            ,CREATE_ID
            ,CREATE_TIME
        ) VALUES (
            'N'
            <if test='adminId != null and adminId != ""'>
            ,#{adminId}
            </if>
            <if test='adminPw != null and adminPw != ""'>
            ,AES128_ENCRYPT(#{adminPw})
            </if>
            <if test='menuAuth != null and menuAuth != ""'>
            ,#{menuAuth}
            </if>
            <if test='dept != null and dept != ""'>
            ,#{dept}
            </if>
            <if test='team != null and team != ""'>
            ,#{team}
            </if>
            <if test='post != null and post != ""'>
            ,#{post}
            </if>
            <if test='duty != null and duty != ""'>
            ,#{duty}
            </if>
            <if test='adminNm != null and adminNm != ""'>
            ,#{adminNm}
            </if>
            ,#{adminBean.adminId}
            ,NOW()
            ,#{adminBean.adminId}
            ,NOW()
        )
    </insert>
    
    <update id="updateUser" parameterType="AdminBean">
        UPDATE T_ADMIN SET
            UPDATE_ID = #{adminBean.adminId}
            ,UPDATE_TIME = NOW()
            <if test='menuAuth != null and menuAuth != ""'>
            ,MENU_AUTH = #{menuAuth}
            </if>
            <if test='dept != null'>
            ,DEPT = #{dept}
            </if>
            <if test='team != null'>
            ,TEAM = #{team}
            </if>
            <if test='post != null'>
            ,POST = #{post}
            </if>
            <if test='duty != null'>
            ,DUTY = #{duty}
            </if>
            <if test='adminNm != null and adminNm != ""'>
            ,ADMIN_NM = #{adminNm}
            </if>
        WHERE ADMIN_ID = #{adminId}
    </update>
    
    <update id="updateUsetDelStatus" parameterType="AdminBean">
        UPDATE T_ADMIN SET
            UPDATE_ID = #{adminBean.adminId}
            ,UPDATE_TIME = NOW()
            ,DEL_YN = #{status}
        WHERE ADMIN_ID IN
        <foreach item="item" index="index" collection="idxs" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>
    
    <update id="updateInitPass" parameterType="AdminBean">
        UPDATE T_ADMIN SET
            UPDATE_ID = #{adminBean.adminId}
            ,UPDATE_TIME = NOW()
            ,ADMIN_PW = AES128_ENCRYPT(#{adminPw})
        WHERE ADMIN_ID = #{adminId}
    </update>
</mapper>